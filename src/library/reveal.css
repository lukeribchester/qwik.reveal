/*
   Targets:
     - .reveal              (single element target)
     - .reveal-group        (group; direct children are targets)

   Modifiers:
     - .reveal-stagger      (enable staggering for group)
     - .reveal--time        (force time-driven)
     - .reveal--scroll      (force scroll-driven; no fallback)
     - .reveal-repeat       (replay for time-driven)
     - .reveal-initial-animate  (time-driven: animate even if initially visible)

   Presets (scroll-driven ranges):
     - .reveal-range--soft | --mid | --late
   Notes:
     - Grids: use .reveal--time for sequential pop-in.
       Scroll-driven staggering for grids is intentionally disabled.
*/

@layer base {
    :root {
        /* Shared “look & feel” tokens */
        --reveal-y: 1.75rem;
        --reveal-blur: 0px;
        --reveal-ease: cubic-bezier(.2, .8, .2, 1);

        /* Time-driven tokens */
        --reveal-duration: 650ms;
        --reveal-delay-step: 90ms;

        /* Time trigger threshold (intersection ratio) */
        --reveal-threshold-view: 0.25;
        --reveal-threshold-screen: 0.6;
        --reveal-threshold: var(--reveal-threshold-view);

        /* Scroll-driven timeline defaults */
        --reveal-view-timeline: view(block 0 0);

        /* Range presets: VIEW defaults */
        --reveal-entry-start-soft: 10%;
        --reveal-entry-end-soft: 60%;

        --reveal-entry-start-mid: 20%;
        --reveal-entry-end-mid: 70%;

        --reveal-entry-start-late: 35%;
        --reveal-entry-end-late: 90%;

        /* Active preset (default = mid) */
        --reveal-entry-start: var(--reveal-entry-start-mid);
        --reveal-entry-end: var(--reveal-entry-end-mid);

        /* Scroll-driven staggering distribution for LINEAR stacks only.
           These are the min/max bounds that children will be distributed across.
           (The enhancer sets --reveal-stagger-last and each child’s --reveal-i.) */
        --reveal-stagger-start-min: 10%;
        --reveal-stagger-start-max: 40%;
        --reveal-stagger-end-min: 70%;
        --reveal-stagger-end-max: 100%;
    }

    /* Screens (snap sections) get different defaults:
       - higher time threshold (so “time” tends to fire when the screen is settled)
       - tighter/earlier scroll ranges (tuned for fast snapping) */
    .reveal-screen {
        --reveal-threshold: var(--reveal-threshold-screen);

        /* Range presets: SCREEN overrides */
        --reveal-entry-start-soft: 10%;
        --reveal-entry-end-soft: 65%;

        --reveal-entry-start-mid: 20%;
        --reveal-entry-end-mid: 65%;

        --reveal-entry-start-late: 35%;
        --reveal-entry-end-late: 85%;
    }
}

@layer components {
    @keyframes reveal-fade-up {
        from {
            opacity: 0;
            translate: 0 var(--reveal-y);
            filter: blur(var(--reveal-blur));
        }
        to {
            opacity: 1;
            translate: 0 0;
            filter: blur(0);
        }
    }

    /* Presets (apply to a target or a group; children inherit) */
    .reveal-range--soft {
        --reveal-entry-start: var(--reveal-entry-start-soft);
        --reveal-entry-end: var(--reveal-entry-end-soft);
    }

    .reveal-range--mid {
        --reveal-entry-start: var(--reveal-entry-start-mid);
        --reveal-entry-end: var(--reveal-entry-end-mid);
    }

    .reveal-range--late {
        --reveal-entry-start: var(--reveal-entry-start-late);
        --reveal-entry-end: var(--reveal-entry-end-late);
    }

    /* Optional: force scroll scope if you ever need it */
    .reveal-scope--view {
        --reveal-scroll-timeline: var(--reveal-view-timeline);
    }

    .reveal-scope--screen {
        --reveal-scroll-timeline: --screen;
    }

    /* -------------------------------------------------------------
       TIME-DRIVEN (works everywhere; driven by data attributes set by JS)
       - data-reveal-driver="time" marks time-managed targets.
       - data-reveal = pending | revealed | shown
    ------------------------------------------------------------- */
    :where([data-reveal-driver="time"]) {
        will-change: opacity, translate, filter;
    }

    :where([data-reveal-driver="time"][data-reveal="pending"]) {
        opacity: 0;
        translate: 0 var(--reveal-y);
        filter: blur(var(--reveal-blur));
    }

    :where([data-reveal-driver="time"][data-reveal="shown"]) {
        opacity: 1;
        translate: 0 0;
        filter: blur(0);
        animation: none;
    }

    :where([data-reveal-driver="time"][data-reveal="revealed"]) {
        /* time-based playback */
        animation-name: reveal-fade-up;
        animation-duration: var(--reveal-duration);
        animation-timing-function: var(--reveal-ease);
        animation-fill-mode: both;

        /* time staggering (index provided by enhancer; defaults to 0) */
        animation-delay: calc(var(--reveal-i, 0) * var(--reveal-delay-step));
    }

    /* -------------------------------------------------------------
       SCROLL-DRIVEN (modern browsers only)
       - auto defaults to scroll-driven when supported
       - forced time (.reveal--time) is excluded
       - group targets are direct children
       - stagger uses math distribution (requires enhancer-provided indices)
    ------------------------------------------------------------- */
    @supports (animation-timeline: view()) {
        :root {
            --reveal-scroll-timeline: var(--reveal-view-timeline);
        }

        .reveal-screen {
            view-timeline-name: --screen;
            view-timeline-axis: block;
            view-timeline-inset: var(--reveal-screen-inset, 0 0);

            /* default: inside screens, scroll is linked to the screen timeline */
            --reveal-scroll-timeline: --screen;
        }

        /* Base scroll-driven target styling (single targets) */
        :where(.reveal):not(.reveal--time) {
            opacity: 0;
            translate: 0 var(--reveal-y);
            filter: blur(var(--reveal-blur));

            animation-name: reveal-fade-up;
            animation-duration: 1s;
            animation-timing-function: var(--reveal-ease);
            animation-fill-mode: both;

            animation-timeline: var(--reveal-scroll-timeline);
            animation-range: entry var(--reveal-entry-start) entry var(--reveal-entry-end);

            will-change: opacity, translate, filter;
        }

        /* Base scroll-driven target styling (group children) */
        :where(.reveal-group):not(.reveal--time) > :where(*):not(.reveal-ignore):not(.reveal--time) {
            opacity: 0;
            translate: 0 var(--reveal-y);
            filter: blur(var(--reveal-blur));

            animation-name: reveal-fade-up;
            animation-duration: 1s;
            animation-timing-function: var(--reveal-ease);
            animation-fill-mode: both;

            animation-timeline: var(--reveal-scroll-timeline);
            animation-range: entry var(--reveal-entry-start) entry var(--reveal-entry-end);

            will-change: opacity, translate, filter;
        }

        /* Scroll-driven range staggering (LINEAR stacks only)
           - Requires: parent has .reveal-stagger
           - The enhancer provides:
             --reveal-stagger-last (>= 1)
             each child: --reveal-i (0..count-1)
        */
        :where(.reveal-group.reveal-stagger):not(.reveal--time) > :where(*):not(.reveal-ignore):not(.reveal--time) {
            animation-range: var(--reveal-range-start-name, cover) clamp(
                    0%,
                    calc(
                            var(--reveal-stagger-start-min) +
                            (var(--reveal-i, 0) *
                            (var(--reveal-stagger-start-max) - var(--reveal-stagger-start-min)) /
                            var(--reveal-stagger-last, 1))
                    ),
                    100%
            ) var(--reveal-range-end-name, contain) clamp(
                    0%,
                    calc(
                            var(--reveal-stagger-end-min) +
                            (var(--reveal-i, 0) *
                            (var(--reveal-stagger-end-max) - var(--reveal-stagger-end-min)) /
                            var(--reveal-stagger-last, 1))
                    ),
                    100%
            );
        }

        /* Don’t attempt per-item scroll stagger for Tailwind grids.
           (Use .reveal--time if you want ordered pop-in.) */
        :where(.reveal-group.reveal-stagger.grid):not(.reveal--time) {
            --reveal-stagger-start-max: var(--reveal-stagger-start-min);
            --reveal-stagger-end-max: var(--reveal-stagger-end-min);
        }
    }

    /* Accessibility: always respect reduced motion */
    @media (prefers-reduced-motion: reduce) {
        :where(.reveal),
        :where(.reveal-group) > :where(*) {
            animation: none !important;
            opacity: 1 !important;
            translate: 0 0 !important;
            filter: blur(0) !important;
        }
    }
}
